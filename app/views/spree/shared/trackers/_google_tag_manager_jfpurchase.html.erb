<% if order_just_completed?(@order) %>
  <% content_for :head do %>
    <script type="text/javascript">
      $(document).on('turbolinks:before-cache', function() {
        $('script#jfpurchase').each(function() {
          this.parentNode.removeChild(this);
        });
      });
    </script>
  <% end %>
  <script id="jfpurchase" type="text/javascript">
    $(document).on('turbolinks:load', function() {
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        'event': 'JFpurchase',
        'orderID': '<%= @order.number %>',
        'conversionValue': <%= sprintf("%.2f", @order.total) %>,
        'currency': '<%= @order.currency %>',
        'email': '<%= @order.email %>',
        'phone_number': '<%=@order.bill_address.phone %>',
        'first_name': '<%= @order.bill_address.first_name %>',
        'last_name': '<%= @order.bill_address.last_name %>',
        'home_address': {
          'street': '<%= (@order.bill_address.address2 ? @order.bill_address.address1 + ', ' + @order.bill_address.address2 : @order.bill_address.address1) %>',
          'city': '<%= @order.bill_address.city %>',
          'region': '<%= @order.bill_address.state_text %>',
          'postal_code': '<%= @order.bill_address.zipcode %>',
          'country': '<%= @order.bill_address.country %>'
        }
      });
    });
  </script>
<% end %>